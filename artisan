require('dotenv/config')
require('ts-node/register')
const fs = require('fs')
const path = require('path')
const inquirer = require('inquirer')
const { program } = require('commander')
const { mkdir } = require('./scripts/helpers/mkdir')
const { rmdir } = require('./scripts/helpers/rmdir')
const { cpdir } = require('./scripts/helpers/cpdir')
const { __, log, error, warn } = require('./scripts/helpers/logger')
const { templateLoader } = require('./scripts/helpers/templateLoader')
const {
	createPage,
	renamePage,
	includePageStyle,
	includePageScript,
} = require('./scripts/pages-utils')

const {
	readConfig,
	renameComponent,
	registerComponent,
	reinjectComponents,
	unregisterComponent,
	getComponentsStore,
	existsComponentByCategory,
	getComponentNamespace,
	getNamespacePathes,
	getNamespaceList,
	getComponentInfo,
	getPageList,
	existsPage,
} = require('./scripts/component-utils')

const {
	APP_PROJECT_STORE,
	APP_COMPONENTS_DIR,
	ARTISAN_TEMPLATE_PUG_COMPONENT,
	ARTISAN_TEMPLATE_SCSS_COMPONENT,
	ARTISAN_TEMPLATE_JS_COMPONENT,
	ARTISAN_COMPONENT_CATEGORIES,
	ARTISAN_COMPONENT_AUTOIMPORT,
} = process.env

program.name('artisan')

const allNamespaces = getNamespaceList()
const allComponents = readConfig().toOneArray()
const allCategories = ARTISAN_COMPONENT_CATEGORIES.split(',')
const allComponentNames = allComponents.map(
	(component) => getComponentInfo(component).name
)
const allStoreComponents = getComponentsStore().filter(
	(component) => !allComponentNames.includes(component)
)

const createPageQuestions = [
	{ type: 'input', name: 'name', message: 'Page name:' },
	{ type: 'confirm', name: 'scss', message: 'Create scss file?' },
	{ type: 'confirm', name: 'js', message: 'Create js file?' },
]

const createComponentQuestions = [
	{ type: 'input', name: 'name', message: 'Component name:' },
	{ type: 'confirm', name: 'pug', message: 'Create pug file?' },
	{ type: 'confirm', name: 'scss', message: 'Create scss file?' },
	{ type: 'confirm', name: 'js', message: 'Create js file?' },
	{
		type: 'list',
		name: 'category',
		message: 'Select component category:',
		choices: allCategories,
	},
	{
		type: 'list',
		name: 'namespace',
		message: 'Where to connect this component?',
		choices: allNamespaces,
	},
]

const removeComponentsQuestions = [
	{
		type: 'list',
		name: 'component',
		message: 'Select component:',
		choices: allComponents,
	},
]

const renamePageQuestions = [
	{
		type: 'list',
		name: 'name',
		message: 'The page you want to rename',
		choices: getPageList(),
	},
	{ type: 'input', name: 'newName', message: 'New page name (without ext):' },
]

const renameComponentQuestions = [
	{
		type: 'list',
		name: 'name',
		message: 'The component you want to rename',
		choices: allComponents,
	},
	{
		type: 'input',
		name: 'newName',
		message: 'New component name (without category):',
	},
]

const importComponentsQuestions = [
	{
		type: 'checkbox',
		name: 'storeComponents',
		message: 'Select components for import form store:',
		choices: allStoreComponents,
	},
]

const autoimportStatus = () => ARTISAN_COMPONENT_AUTOIMPORT == 'true'
const inquirerError = (err) => error(__('ERROR'), err)

program
	.command('create:page')
	.description('create new page')
	.option('-f', 'force creating')
	.action((options) => {
		inquirer
			.prompt(createPageQuestions)
			.then(({ name, scss, js }) => {
				const pathes = getNamespacePathes(name)

				if (!options.f && pathes.pugFileExists) {
					return error(__('ERROR_PAGE_FILE_EXISTS', { file: 'Pug' }))
				}

				if (!options.f && pathes.scssFileExists && scss) {
					return error(__('ERROR_PAGE_FILE_EXISTS', { file: 'Scss' }))
				}

				if (!options.f && pathes.jsFileExists && js) {
					return error(__('ERROR_PAGE_FILE_EXISTS', { file: 'Js' }))
				}

				createPage(name)
				if (scss) includePageStyle(name)
				if (js) includePageScript(name)
			})
			.catch(inquirerError)
	})

program
	.command('create:component')
	.description('create new component')
	.option('-f', 'force creating')
	.action((options) => {
		inquirer
			.prompt(createComponentQuestions)
			.then(({ name, pug, scss, js, category, namespace }) => {
				const componentsDirPath = APP_COMPONENTS_DIR
				const targeteNamespace = namespace.replace('.pug', '')
				const categoryDirPath = path.join(componentsDirPath, category)
				const targetDirPath = path.join(categoryDirPath, name)
				const targetPath = path.join(targetDirPath, name)

				if (!options.f && fs.existsSync(targetDirPath)) {
					return error(
						__('ERROR_COMPONENT_EXISTS', { component: name, category })
					)
				}

				mkdir(targetDirPath)

				if (pug) {
					templateLoader()
						.load(ARTISAN_TEMPLATE_PUG_COMPONENT)
						.replace(/\${name}/g, name)
						.write(`${targetPath}.pug`)
				}

				if (scss) {
					templateLoader()
						.load(ARTISAN_TEMPLATE_SCSS_COMPONENT)
						.replace(/\${name}/g, name)
						.write(`${targetPath}.scss`)
				}

				if (js) {
					templateLoader()
						.load(ARTISAN_TEMPLATE_JS_COMPONENT)
						.write(`${targetPath}.js`)
				}

				log(__('LOG_SUCCESS_COMPONENT_ADDED', { name }))

				registerComponent(targeteNamespace, category, name)

				if (autoimportStatus()) {
					reinjectComponents(targeteNamespace)
				}
			})
			.catch(inquirerError)
	})

program
	.command('reinject:components')
	.description('reinject all components')
	.action(() => {
		if (!autoimportStatus()) {
			return warn(__('WARN_AUTOIMPORT_TURN_OFF'))
		}

		reinjectComponents('all')
	})

program
	.command('remove:component')
	.description('remove component')
	.action(() => {
		inquirer
			.prompt(removeComponentsQuestions)
			.then(({ component }) => {
				rmdir(path.join(APP_COMPONENTS_DIR, component))

				unregisterComponent(...component.split('/'))

				if (autoimportStatus()) {
					reinjectComponents('all')
				}
			})
			.catch(inquirerError)
	})

program
	.command('rename:page')
	.description('renaming page')
	.action(() => {
		inquirer
			.prompt(renamePageQuestions)
			.then(({ name, newName }) => {
				if (existsPage(newName)) {
					return error(__('ERROR_NAME_TAKEN', { name: newName }))
				}

				renamePage(name, newName)
			})
			.catch(inquirerError)
	})

program
	.command('rename:component')
	.description('renaming component')
	.action(() => {
		inquirer
			.prompt(renameComponentQuestions)
			.then(({ name, newName }) => {
				const namespace = getComponentNamespace(name)
				const { category } = getComponentInfo(name)

				if (existsComponentByCategory(category, newName)) {
					error(__('ERROR_NAME_TAKEN', { name: newName }))
					return
				}

				renameComponent(name, newName)
				reinjectComponents(namespace)
			})
			.catch(inquirerError)
	})

program
	.command('import:components')
	.description('importing components from store')
	.action(() => {
		if (allStoreComponents.length === 0) {
			return warn(__('WARN_NON_EXISTS_STORE_COMPONENTS'))
		}

		inquirer
			.prompt(importComponentsQuestions)
			.then(({ storeComponents }) => {
				const questions = []

				for (const component of storeComponents) {
					questions.push(
						{
							type: 'list',
							name: `category:${component}`,
							message: `Select category for \x1b[44m${component}\x1b[0m:`,
							choices: allCategories,
						},
						{
							type: 'list',
							name: `namespace:${component}`,
							message: `Select namespace for \x1b[44m${component}\x1b[0m:`,
							choices: allNamespaces,
						}
					)
				}

				inquirer
					.prompt(questions)
					.then((choices) => {
						for (const name of storeComponents) {
							const category = choices[`category:${name}`]
							const namespace = choices[`namespace:${name}`]
							const fromPath = path.join(APP_PROJECT_STORE, name)
							const toPath = path.join(APP_COMPONENTS_DIR, category, name)

							cpdir(fromPath, toPath)

							registerComponent(namespace, category, name)

							if (autoimportStatus()) {
								reinjectComponents(namespace)
							}
						}
					})
					.catch(inquirerError)
			})
			.catch(inquirerError)
	})

program.parse()
